@model GestionProjects.Domain.Models.Projet

@{
    var userId = Guid.Parse(User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value ?? Guid.Empty.ToString());
    var isChefProjet = (User.IsInRole("ChefDeProjet") && Model.ChefProjetId == userId) || User.IsInRole("ResponsableSolutionsIT");
    var isResponsableSolutionsIT = User.IsInRole("ResponsableSolutionsIT");
    var isDSI = User.IsInRole("DSI") || User.IsInRole("AdminIT");
    var charteValideeCompletement = Model.CharteValideeParDM && Model.CharteValideeParDSI;
    var canValiderPhaseAnalyse = isChefProjet && Model.PhaseActuelle == GestionProjects.Domain.Enums.PhaseProjet.AnalyseClarification && charteValideeCompletement;
    var livrablesAnalyse = Model.Livrables?.Where(l => l.Phase == GestionProjects.Domain.Enums.PhaseProjet.AnalyseClarification).ToList() ?? new List<GestionProjects.Domain.Models.LivrableProjet>();
}

<div class="card-modern mb-4">
    <div class="card-header-modern">
        <div>
            <h3 class="card-title-modern" style="font-size: 1.1rem;">
                <i class="bi bi-search"></i>
                Phase Analyse & Clarification
            </h3>
            <div style="margin-top: var(--spacing-sm); display: flex; gap: var(--spacing-sm); flex-wrap: wrap;">
                @if (Model.CharteValideeParDM)
                {
                    <span class="badge-modern badge-modern-success">
                        <i class="bi bi-check-circle"></i>
                        DM validé le @Model.DateCharteValideeParDM?.ToString("dd/MM/yyyy")
                    </span>
                }
                else
                {
                    <span class="badge-modern badge-modern-warning">
                        <i class="bi bi-clock"></i>
                        En attente validation DM
                    </span>
                }
                @if (Model.CharteValideeParDSI)
                {
                    <span class="badge-modern badge-modern-success">
                        <i class="bi bi-check-circle"></i>
                        DSI validé le @Model.DateCharteValideeParDSI?.ToString("dd/MM/yyyy")
                    </span>
                }
                else
                {
                    <span class="badge-modern badge-modern-warning">
                        <i class="bi bi-clock"></i>
                        En attente validation DSI
                    </span>
                }
                @if (charteValideeCompletement)
                {
                    <span class="badge-modern badge-modern-success">
                        <i class="bi bi-check-circle-fill"></i>
                        Charte validée
                    </span>
                }
            </div>
        </div>
        @if (isChefProjet && Model.PhaseActuelle == GestionProjects.Domain.Enums.PhaseProjet.AnalyseClarification)
        {
            <div style="display: flex; gap: var(--spacing-sm); flex-wrap: wrap;">
                <a asp-action="CharteProjet" asp-route-id="@Model.Id" class="btn-modern btn-modern-primary">
                    <i class="bi bi-file-earmark-text"></i>
                    Éditer Charte Projet
                </a>
                <form asp-action="GenererChartePdf" method="post" style="display: inline;">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="id" value="@Model.Id" />
                    <button type="submit" class="btn-modern btn-modern-primary">
                        <i class="bi bi-file-earmark-pdf"></i>
                        Générer PDF Charte
                    </button>
                </form>
                <form asp-action="ValiderPhaseAnalyse" method="post" style="display: inline;">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="id" value="@Model.Id" />
                    @if (charteValideeCompletement)
                    {
                        <button type="submit" class="btn-modern btn-modern-success" onclick="return confirm('Valider la phase Analyse ? Cette action passera le projet en phase Planification.');">
                            <i class="bi bi-check-circle"></i>
                            Valider la phase Analyse (Go/No-Go)
                        </button>
                    }
                    else
                    {
                        <button type="button" class="btn-modern btn-modern-secondary" disabled title="La charte doit être validée par le Directeur Métier et la DSI avant de pouvoir valider la phase Analyse.">
                            <i class="bi bi-check-circle"></i>
                            Valider la phase Analyse (Go/No-Go)
                        </button>
                        <small class="text-muted" style="display: block; margin-top: var(--spacing-xs); font-size: 0.875rem;">
                            <i class="bi bi-info-circle"></i> La charte doit être validée par le DM et la DSI avant de valider la phase Analyse.
                        </small>
                    }
                </form>
            </div>
        }
    </div>
    <div class="card-body-modern">
        <div style="margin-bottom: var(--spacing-lg);">
            <h6 style="color: var(--gray-700); font-weight: 600; margin-bottom: var(--spacing-sm);">Contexte</h6>
            <p style="color: var(--gray-600); white-space: pre-wrap;">@(Model.DemandeProjet?.Contexte ?? "N/A")</p>
        </div>
        
        <div style="margin-bottom: var(--spacing-lg);">
            <h6 style="color: var(--gray-700); font-weight: 600; margin-bottom: var(--spacing-sm);">Objectifs</h6>
            <p style="color: var(--gray-600); white-space: pre-wrap;">@(Model.DemandeProjet?.Objectifs ?? "N/A")</p>
        </div>

        <hr style="margin: var(--spacing-lg) 0; border-color: var(--gray-200);" />

        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-md);">
            <h6 style="color: var(--gray-700); font-weight: 600; margin: 0;">Livrables d'analyse</h6>
            @if (isChefProjet && Model.PhaseActuelle == GestionProjects.Domain.Enums.PhaseProjet.AnalyseClarification)
            {
                <button type="button" class="btn-modern btn-modern-primary" data-bs-toggle="modal" data-bs-target="#uploadLivrableModal" data-phase="AnalyseClarification">
                    <i class="bi bi-upload"></i>
                    Upload Livrable
                </button>
            }
        </div>

        @if (livrablesAnalyse.Any())
        {
            <div style="display: flex; flex-direction: column; gap: var(--spacing-sm);">
                @foreach (var livrable in livrablesAnalyse)
                {
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: var(--spacing-md); background: var(--gray-50); border-radius: var(--radius-lg);">
                        <div style="display: flex; align-items: center; gap: var(--spacing-md);">
                            <i class="bi bi-file-earmark" style="font-size: 1.5rem; color: var(--primary-blue);"></i>
                            <div>
                                <a href="~/@livrable.CheminRelatif" target="_blank" style="color: var(--primary-blue); text-decoration: none; font-weight: 500;">
                                    @livrable.NomDocument
                                </a>
                                <div style="font-size: 0.875rem; color: var(--gray-500);">
                                    Type: @livrable.TypeLivrable | Déposé le @livrable.DateDepot.ToString("dd/MM/yyyy")
                                </div>
                            </div>
                        </div>
                        <a href="~/@livrable.CheminRelatif" target="_blank" class="btn-modern btn-modern-secondary" style="padding: var(--spacing-xs) var(--spacing-md);">
                            <i class="bi bi-download"></i>
                        </a>
                    </div>
                }
            </div>
        }
        else
        {
            <div style="text-align: center; padding: var(--spacing-xl); color: var(--gray-500);">
                <i class="bi bi-inbox" style="font-size: 2rem; margin-bottom: var(--spacing-sm);"></i>
                <p>Aucun livrable d'analyse pour le moment.</p>
            </div>
        }
    </div>
</div>

<!-- Commentaires techniques (Responsable Solutions IT) -->
@if (isResponsableSolutionsIT || isDSI)
{
    <div class="card-modern mb-4" style="border-left: 4px solid #dbb438;">
        <div class="card-header-modern">
            <h3 class="card-title-modern" style="font-size: 1.1rem;">
                <i class="bi bi-chat-dots" style="color: #dbb438;"></i>
                Analyse technique continue
            </h3>
        </div>
        <div class="card-body-modern">
            @if (!string.IsNullOrWhiteSpace(Model.CommentaireTechnique))
            {
                <div style="margin-bottom: var(--spacing-md); padding: var(--spacing-md); background: #fef9e7; border-radius: var(--radius-lg);">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: var(--spacing-sm);">
                        <div>
                            <strong style="color: var(--gray-800);">Commentaire technique</strong>
                            @if (Model.DernierCommentaireTechniquePar != null)
                            {
                                <div style="font-size: 0.875rem; color: var(--gray-500); margin-top: var(--spacing-xs);">
                                    Par @Model.DernierCommentaireTechniquePar.Nom @Model.DernierCommentaireTechniquePar.Prenoms
                                    @if (Model.DateDernierCommentaireTechnique.HasValue)
                                    {
                                        <span>le @Model.DateDernierCommentaireTechnique.Value.ToString("dd/MM/yyyy HH:mm")</span>
                                    }
                                </div>
                            }
                        </div>
                    </div>
                    <p style="color: var(--gray-700); white-space: pre-wrap; margin: 0;">@Model.CommentaireTechnique</p>
                </div>
            }
            else
            {
                <div style="text-align: center; padding: var(--spacing-lg); color: var(--gray-500);">
                    <i class="bi bi-chat-dots" style="font-size: 2rem; margin-bottom: var(--spacing-sm);"></i>
                    <p>Aucun commentaire technique pour le moment.</p>
                </div>
            }
            
            @if (isResponsableSolutionsIT)
            {
                <form asp-action="AjouterCommentaireTechnique" method="post">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="id" value="@Model.Id" />
                    <div class="form-group-modern">
                        <label class="form-label-modern">Ajouter / Modifier un commentaire technique</label>
                        <textarea name="commentaireTechnique" class="form-control-modern" rows="6" placeholder="Ajoutez vos observations techniques, risques identifiés, recommandations...">@Model.CommentaireTechnique</textarea>
                        <small style="color: var(--gray-500); font-size: 0.875rem;">
                            <i class="bi bi-info-circle"></i> Ces commentaires sont visibles par la DSI et le Responsable Solutions IT.
                        </small>
                    </div>
                    <div style="display: flex; justify-content: flex-end; margin-top: var(--spacing-md);">
                        <button type="submit" class="btn-modern btn-modern-primary">
                            <i class="bi bi-save"></i>
                            Enregistrer le commentaire
                        </button>
                    </div>
                </form>
            }
        </div>
    </div>
}

@if (isChefProjet && Model.PhaseActuelle == GestionProjects.Domain.Enums.PhaseProjet.AnalyseClarification)
{
    <div class="card-modern">
        <div class="card-header-modern">
            <h3 class="card-title-modern" style="font-size: 1.1rem;">
                <i class="bi bi-people"></i>
                Membres du projet
            </h3>
        </div>
        <div class="card-body-modern">
            @if (Model.Membres != null && Model.Membres.Any())
            {
                <div class="table-modern">
                    <table style="width: 100%;">
                        <thead>
                            <tr>
                                <th>Nom</th>
                                <th>Rôle</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var membre in Model.Membres)
                            {
                                <tr>
                                    <td>@membre.Nom @membre.Prenom</td>
                                    <td>@membre.RoleDansProjet</td>
                                    <td>
                                        <button class="btn-modern btn-modern-danger" style="padding: var(--spacing-xs) var(--spacing-md); font-size: 0.875rem;">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            <button type="button" class="btn-modern btn-modern-primary mt-3" data-bs-toggle="modal" data-bs-target="#ajouterMembreModal">
                <i class="bi bi-plus-circle"></i>
                Ajouter un membre
            </button>
        </div>
    </div>
}



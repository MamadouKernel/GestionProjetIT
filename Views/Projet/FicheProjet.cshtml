@model GestionProjects.Domain.Models.FicheProjet

@{
    ViewData["Title"] = "Fiche Projet CIT";
    var projet = ViewBag.Projet as GestionProjects.Domain.Models.Projet;
    var userId = Guid.Parse(User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value ?? Guid.Empty.ToString());
    var isChefProjet = User.IsInRole("ChefDeProjet") && projet?.ChefProjetId == userId;
    var isDSI = User.IsInRole("DSI") || User.IsInRole("AdminIT");
    var canEdit = isChefProjet || isDSI || User.IsInRole("ResponsableSolutionsIT");
}

<div class="fade-in">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="display-6 mb-0">
            <i class="bi bi-file-text" style="color: var(--primary-blue);"></i>
            Fiche Projet CIT - @projet?.CodeProjet
        </h2>
        <div>
            <a asp-action="Details" asp-route-id="@projet?.Id" class="btn-modern btn-modern-secondary">
                <i class="bi bi-arrow-left"></i> Retour
            </a>
            <form asp-action="GenererFicheProjetWord" method="post" style="display: inline;">
                @Html.AntiForgeryToken()
                <input type="hidden" name="id" value="@projet?.Id" />
                <button type="submit" class="btn-modern btn-modern-primary">
                    <i class="bi bi-file-earmark-word"></i> Télécharger Word
                </button>
            </form>
            @if (canEdit)
            {
                <button type="button" class="btn-modern btn-modern-primary" onclick="toggleEditMode()">
                    <i class="bi bi-pencil"></i> <span id="editModeText">Éditer</span>
                </button>
            }
        </div>
    </div>

    <form asp-action="SauvegarderFicheProjet" method="post" id="ficheForm">
        @Html.AntiForgeryToken()
        <input type="hidden" name="id" value="@projet?.Id" />
        <input type="hidden" asp-for="Id" />
        <input type="hidden" asp-for="ProjetId" />

        <!-- 1. Identification du projet -->
        <div class="card-modern mb-4">
            <div class="card-header-modern" style="background: linear-gradient(135deg, var(--primary-blue) 0%, #2a6ba0 100%); color: white;">
                <h3 class="card-title-modern mb-0" style="color: white;">
                    <i class="bi bi-1-circle"></i>
                    1. Identification du Projet
                </h3>
            </div>
            <div class="card-body-modern">
                <div class="row">
                    <div class="col-md-12 mb-3">
                        <div style="display: grid; grid-template-columns: 150px 1fr; gap: var(--spacing-md); align-items: center;">
                            <strong style="color: var(--gray-700);">Code projet</strong>
                            <div style="color: var(--primary-blue); font-weight: 600;">@projet?.CodeProjet</div>
                            
                            <strong style="color: var(--gray-700);">Titre court</strong>
                            <input asp-for="TitreCourt" class="form-control-modern" placeholder="@projet?.Titre" />
                            
                            <strong style="color: var(--gray-700);">Titre long</strong>
                            <input asp-for="TitreLong" class="form-control-modern" placeholder="@projet?.Titre" />
                            
                            <strong style="color: var(--gray-700);">Direction métier porteuse</strong>
                            <div>@projet?.Direction?.Libelle</div>
                            
                            <strong style="color: var(--gray-700);">Demandeur</strong>
                            <div>@projet?.DemandeProjet?.Demandeur?.Nom @projet?.DemandeProjet?.Demandeur?.Prenoms</div>
                            
                            <strong style="color: var(--gray-700);">Sponsor (Directeur métier)</strong>
                            <div>@projet?.Sponsor?.Nom @projet?.Sponsor?.Prenoms</div>
                            
                            <strong style="color: var(--gray-700);">Chef de Projet DSI</strong>
                            <div>@(projet?.ChefProjet != null ? $"{projet.ChefProjet.Nom} {projet.ChefProjet.Prenoms}" : "Non assigné")</div>
                            
                            <strong style="color: var(--gray-700);">Date de demande</strong>
                            <div>@projet?.DemandeProjet?.DateSoumission.ToString("dd/MM/yyyy")</div>
                            
                            <strong style="color: var(--gray-700);">Date d'initiation</strong>
                            <div>@(projet?.DateDebut?.ToString("dd/MM/yyyy") ?? "N/A")</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2. Objectifs & description -->
        <div class="card-modern mb-4">
            <div class="card-header-modern">
                <h3 class="card-title-modern">
                    <i class="bi bi-2-circle"></i>
                    2. Objectifs & Description
                </h3>
            </div>
            <div class="card-body-modern">
                <div class="form-group-modern mb-3">
                    <label class="form-label-modern">Objectif principal (3-5 lignes)</label>
                    <textarea asp-for="ObjectifPrincipal" class="form-control-modern" rows="5"></textarea>
                </div>
                <div class="form-group-modern mb-3">
                    <label class="form-label-modern">Contexte / Problème adressé</label>
                    <textarea asp-for="ContexteProblemeAdresse" class="form-control-modern" rows="4"></textarea>
                </div>
                <div class="form-group-modern mb-3">
                    <label class="form-label-modern">Description synthétique du projet</label>
                    <textarea asp-for="DescriptionSynthetique" class="form-control-modern" rows="4"></textarea>
                </div>
                <div class="form-group-modern mb-3">
                    <label class="form-label-modern">Résultats attendus</label>
                    <textarea asp-for="ResultatsAttendus" class="form-control-modern" rows="4"></textarea>
                </div>
            </div>
        </div>

        <!-- 3. Périmètre -->
        <div class="card-modern mb-4">
            <div class="card-header-modern">
                <h3 class="card-title-modern">
                    <i class="bi bi-3-circle"></i>
                    3. Périmètre
                </h3>
            </div>
            <div class="card-body-modern">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group-modern">
                            <label class="form-label-modern">Périmètre inclus (IN) : liste courte</label>
                            <textarea asp-for="PerimetreInclus" class="form-control-modern" rows="5" placeholder="Un élément par ligne"></textarea>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group-modern">
                            <label class="form-label-modern">Périmètre exclu (OUT) : liste courte</label>
                            <textarea asp-for="PerimetreExclu" class="form-control-modern" rows="5" placeholder="Un élément par ligne"></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 4. Indicateurs clés -->
        <div class="card-modern mb-4">
            <div class="card-header-modern">
                <h3 class="card-title-modern">
                    <i class="bi bi-4-circle"></i>
                    4. Indicateurs Clés
                </h3>
            </div>
            <div class="card-body-modern">
                <div class="form-group-modern mb-3">
                    <label class="form-label-modern">Bénéfices attendus (opérationnels, financiers, qualité, conformité…)</label>
                    <textarea asp-for="BeneficesAttendus" class="form-control-modern" rows="4"></textarea>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group-modern">
                            <label class="form-label-modern">Criticité / Urgence</label>
                            <input asp-for="CriticiteUrgence" class="form-control-modern" />
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group-modern">
                            <label class="form-label-modern">Type de projet (SI / Infra / Applicatif / Process / Conformité…)</label>
                            <input asp-for="TypeProjet" class="form-control-modern" />
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 5. Planning synthétique -->
        <div class="card-modern mb-4">
            <div class="card-header-modern">
                <h3 class="card-title-modern">
                    <i class="bi bi-5-circle"></i>
                    5. Planning Synthétique
                </h3>
            </div>
            <div class="card-body-modern">
                <div style="display: grid; grid-template-columns: 200px 1fr; gap: var(--spacing-md); align-items: center;">
                    <strong style="color: var(--gray-700);">Phase actuelle</strong>
                    <span class="badge-modern badge-modern-info">@projet?.PhaseActuelle</span>
                    
                    <strong style="color: var(--gray-700);">Date début</strong>
                    <div>@(projet?.DateDebut?.ToString("dd/MM/yyyy") ?? "N/A")</div>
                    
                    <strong style="color: var(--gray-700);">Date fin prévisionnelle</strong>
                    <div>@(projet?.DateFinPrevue?.ToString("dd/MM/yyyy") ?? "N/A")</div>
                    
                    <strong style="color: var(--gray-700);">Prochain jalon</strong>
                    <input asp-for="ProchainJalon" class="form-control-modern" />
                    
                    <strong style="color: var(--gray-700);">Statut</strong>
                    <span class="badge-modern badge-modern-@(projet?.EtatProjet == GestionProjects.Domain.Enums.EtatProjet.Vert ? "success" : projet?.EtatProjet == GestionProjects.Domain.Enums.EtatProjet.Orange ? "warning" : "danger")">
                        @projet?.EtatProjet
                    </span>
                    
                    <strong style="color: var(--gray-700);">% Avancement</strong>
                    <div>
                        <div style="display: flex; align-items: center; gap: var(--spacing-sm);">
                            <div style="flex: 1; height: 8px; background: var(--gray-200); border-radius: var(--radius-lg); overflow: hidden;">
                                <div style="height: 100%; width: @(projet?.PourcentageAvancement ?? 0)%; background: var(--primary-blue);"></div>
                            </div>
                            <span style="font-weight: 600;">@(projet?.PourcentageAvancement ?? 0)%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 6. Principaux risques -->
        <div class="card-modern mb-4">
            <div class="card-header-modern">
                <h3 class="card-title-modern">
                    <i class="bi bi-6-circle"></i>
                    6. Principaux Risques (3 à 5 risques clés max)
                </h3>
            </div>
            <div class="card-body-modern">
                <div class="form-group-modern">
                    <label class="form-label-modern">Synthèse des risques</label>
                    <textarea asp-for="SyntheseRisques" class="form-control-modern" rows="6" placeholder="Pour chaque risque : Description, Impact, Statut (Actif / Levé)"></textarea>
                </div>
                @if (projet?.Risques != null && projet.Risques.Any(r => !r.EstSupprime))
                {
                    <div class="mt-3">
                        <strong>Risques enregistrés dans le projet :</strong>
                        <ul class="mt-2">
                            @foreach (var risque in projet.Risques.Where(r => !r.EstSupprime).Take(5))
                            {
                                <li>
                                    <strong>@risque.Description</strong>
                                    <span class="badge-modern badge-modern-@(risque.Statut == GestionProjects.Domain.Enums.StatutRisque.Maitrise || risque.Statut == GestionProjects.Domain.Enums.StatutRisque.Clos ? "success" : "warning")">
                                        @risque.Statut
                                    </span>
                                </li>
                            }
                        </ul>
                    </div>
                }
            </div>
        </div>

        <!-- 7. Gouvernance et acteurs -->
        <div class="card-modern mb-4">
            <div class="card-header-modern">
                <h3 class="card-title-modern">
                    <i class="bi bi-7-circle"></i>
                    7. Gouvernance et Acteurs
                </h3>
            </div>
            <div class="card-body-modern">
                <div style="display: grid; grid-template-columns: 200px 1fr; gap: var(--spacing-md); align-items: start; margin-bottom: var(--spacing-md);">
                    <strong style="color: var(--gray-700);">Chef de Projet DSI</strong>
                    <div>@(projet?.ChefProjet != null ? $"{projet.ChefProjet.Nom} {projet.ChefProjet.Prenoms}" : "Non assigné")</div>
                    
                    <strong style="color: var(--gray-700);">Sponsor</strong>
                    <div>@projet?.Sponsor?.Nom @projet?.Sponsor?.Prenoms</div>
                </div>
                <div class="form-group-modern mb-3">
                    <label class="form-label-modern">Équipe projet (liste courte : Nom + Rôle)</label>
                    <textarea asp-for="EquipeProjet" class="form-control-modern" rows="5" placeholder="Un membre par ligne"></textarea>
                </div>
                <div class="form-group-modern mb-3">
                    <label class="form-label-modern">Parties prenantes clés (ops, billing, support, fournisseurs…)</label>
                    <textarea asp-for="PartiesPrenantesCles" class="form-control-modern" rows="4"></textarea>
                </div>
            </div>
        </div>

        <!-- 8. Livrables obligatoires -->
        <div class="card-modern mb-4">
            <div class="card-header-modern">
                <h3 class="card-title-modern">
                    <i class="bi bi-8-circle"></i>
                    8. Livrables Obligatoires (Suivi Rapide)
                </h3>
            </div>
            <div class="card-body-modern">
                <div class="table-responsive">
                    <table class="table-modern">
                        <thead>
                            <tr>
                                <th>Phase</th>
                                <th>Livrables</th>
                                <th style="width: 100px;">Statut</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>Analyse / Clarification</strong></td>
                                <td>Charte Projet</td>
                                <td class="text-center">
                                    @if (Model.CharteProjetPresente)
                                    {
                                        <span class="badge-modern badge-modern-success">✔</span>
                                    }
                                    else
                                    {
                                        <span class="badge-modern badge-modern-danger">✖</span>
                                    }
                                </td>
                            </tr>
                            <tr>
                                <td><strong>Planification</strong></td>
                                <td>WBS / Planning / RACI / Budget</td>
                                <td class="text-center">
                                    @if (Model.WBSPlanningRACIBudgetPresent)
                                    {
                                        <span class="badge-modern badge-modern-success">✔</span>
                                    }
                                    else
                                    {
                                        <span class="badge-modern badge-modern-danger">✖</span>
                                    }
                                </td>
                            </tr>
                            <tr>
                                <td><strong>Exécution</strong></td>
                                <td>CR réunions</td>
                                <td class="text-center">
                                    @if (Model.CRReunionsPresent)
                                    {
                                        <span class="badge-modern badge-modern-success">✔</span>
                                    }
                                    else
                                    {
                                        <span class="badge-modern badge-modern-danger">✖</span>
                                    }
                                </td>
                            </tr>
                            <tr>
                                <td><strong>Recette & MEP</strong></td>
                                <td>Cahier tests / PV Recette / PV MEP</td>
                                <td class="text-center">
                                    @if (Model.CahierTestsPVRecettePVMEPPresent)
                                    {
                                        <span class="badge-modern badge-modern-success">✔</span>
                                    }
                                    else
                                    {
                                        <span class="badge-modern badge-modern-danger">✖</span>
                                    }
                                </td>
                            </tr>
                            <tr>
                                <td><strong>Clôture</strong></td>
                                <td>Rapport / Leçons apprises / PV Clôture</td>
                                <td class="text-center">
                                    @if (Model.RapportLeconsApprisesPVCloturePresent)
                                    {
                                        <span class="badge-modern badge-modern-success">✔</span>
                                    }
                                    else
                                    {
                                        <span class="badge-modern badge-modern-danger">✖</span>
                                    }
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 9. Budget -->
        <div class="card-modern mb-4">
            <div class="card-header-modern">
                <h3 class="card-title-modern">
                    <i class="bi bi-9-circle"></i>
                    9. Budget (Optionnel pour CIT)
                </h3>
            </div>
            <div class="card-body-modern">
                <div class="row">
                    <div class="col-md-4">
                        <div class="form-group-modern">
                            <label class="form-label-modern">Budget prévisionnel</label>
                            <input asp-for="BudgetPrevisionnel" type="number" step="0.01" class="form-control-modern" />
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group-modern">
                            <label class="form-label-modern">Budget consommé</label>
                            <input asp-for="BudgetConsomme" type="number" step="0.01" class="form-control-modern" />
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group-modern">
                            <label class="form-label-modern">Écarts</label>
                            <input asp-for="EcartsBudget" type="number" step="0.01" class="form-control-modern" readonly />
                        </div>
                    </div>
                </div>
                @{
                    var ecartPourcentage = 0m;
                    if (Model.BudgetPrevisionnel.HasValue && Model.BudgetConsomme.HasValue && Model.BudgetPrevisionnel.Value > 0)
                    {
                        ecartPourcentage = Math.Abs((Model.BudgetConsomme.Value - Model.BudgetPrevisionnel.Value) / Model.BudgetPrevisionnel.Value * 100);
                    }
                }
                @if (ecartPourcentage > 10)
                {
                    <div class="alert-modern alert-modern-warning mt-3">
                        <i class="bi bi-exclamation-triangle"></i>
                        <strong>Attention :</strong> Un écart de @ecartPourcentage.ToString("F1")% a été détecté. Une justification est <strong>obligatoire</strong> pour les écarts supérieurs à 10%.
                    </div>
                    <div class="form-group-modern mt-3">
                        <label class="form-label-modern">
                            Justification de l'écart budget <span class="text-danger">*</span>
                        </label>
                        <textarea asp-for="JustificationEcartBudget" class="form-control-modern" rows="4" required placeholder="Expliquez les raisons de l'écart budgétaire..."></textarea>
                        <small class="form-text text-muted">
                            @if (Model.JustificationPar != null && Model.DateJustificationEcart.HasValue)
                            {
                                <span>Justifié par @Model.JustificationPar.Nom @Model.JustificationPar.Prenoms le @Model.DateJustificationEcart.Value.ToString("dd/MM/yyyy")</span>
                            }
                        </small>
                    </div>
                }
            </div>
        </div>

        <!-- 10. Synthèse DSI -->
        <div class="card-modern mb-4">
            <div class="card-header-modern" style="background: linear-gradient(135deg, var(--info) 0%, #0284c7 100%); color: white;">
                <h3 class="card-title-modern mb-0" style="color: white;">
                    <i class="bi bi-10-circle"></i>
                    10. Synthèse DSI
                </h3>
            </div>
            <div class="card-body-modern">
                <div class="form-group-modern mb-3">
                    <label class="form-label-modern">Points forts du projet</label>
                    <textarea asp-for="PointsForts" class="form-control-modern" rows="4"></textarea>
                </div>
                <div class="form-group-modern mb-3">
                    <label class="form-label-modern">Points de vigilance</label>
                    <textarea asp-for="PointsVigilance" class="form-control-modern" rows="4"></textarea>
                </div>
                <div class="form-group-modern mb-3">
                    <label class="form-label-modern">Décisions attendues</label>
                    <textarea asp-for="DecisionsAttendues" class="form-control-modern" rows="3"></textarea>
                </div>
                <div class="form-group-modern mb-3">
                    <label class="form-label-modern">Demandes d'arbitrage (si nécessaire)</label>
                    <textarea asp-for="DemandesArbitrage" class="form-control-modern" rows="3"></textarea>
                </div>
            </div>
        </div>

        @if (Model.DateDerniereMiseAJour.HasValue)
        {
            <div class="text-muted text-end mb-3" style="font-size: 0.875rem;">
                Dernière mise à jour : @Model.DateDerniereMiseAJour.Value.ToString("dd/MM/yyyy à HH:mm")
                @if (Model.DerniereMiseAJourPar != null)
                {
                    <span>par @Model.DerniereMiseAJourPar.Nom @Model.DerniereMiseAJourPar.Prenoms</span>
                }
            </div>
        }

        @if (canEdit)
        {
            <div class="d-flex justify-content-end gap-2 mb-4">
                <a asp-action="Details" asp-route-id="@projet?.Id" class="btn-modern btn-modern-secondary">
                    <i class="bi bi-x-circle"></i> Annuler
                </a>
                <button type="submit" class="btn-modern btn-modern-primary">
                    <i class="bi bi-check-circle"></i> Enregistrer
                </button>
            </div>
        }
    </form>
</div>

<script>
    let editMode = false;

    function toggleEditMode() {
        editMode = !editMode;
        const inputs = document.querySelectorAll('#ficheForm input, #ficheForm textarea, #ficheForm select');
        inputs.forEach(input => {
            if (input.type !== 'hidden' && !input.readOnly) {
                input.disabled = !editMode;
            }
        });
        document.getElementById('editModeText').textContent = editMode ? 'Annuler' : 'Éditer';
    }

    // Calcul automatique des écarts budgétaires
    document.addEventListener('DOMContentLoaded', function() {
        const budgetPrevisionnel = document.querySelector('input[name="BudgetPrevisionnel"]');
        const budgetConsomme = document.querySelector('input[name="BudgetConsomme"]');
        const ecartsBudget = document.querySelector('input[name="EcartsBudget"]');

        function calculerEcarts() {
            const prev = parseFloat(budgetPrevisionnel?.value) || 0;
            const cons = parseFloat(budgetConsomme?.value) || 0;
            if (ecartsBudget) {
                ecartsBudget.value = (cons - prev).toFixed(2);
            }
        }

        if (budgetPrevisionnel) budgetPrevisionnel.addEventListener('input', calculerEcarts);
        if (budgetConsomme) budgetConsomme.addEventListener('input', calculerEcarts);

        // Désactiver les champs au chargement si pas en mode édition
        if (!@canEdit.ToString().ToLower()) {
            const inputs = document.querySelectorAll('#ficheForm input, #ficheForm textarea, #ficheForm select');
            inputs.forEach(input => {
                if (input.type !== 'hidden' && !input.readOnly) {
                    input.disabled = true;
                }
            });
        }
    });
</script>


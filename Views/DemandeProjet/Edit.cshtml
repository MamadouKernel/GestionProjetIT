@model GestionProjects.Domain.Models.DemandeProjet

@{
    ViewData["Title"] = "Modifier la Demande";
    var isCorrection = Model.StatutDemande == GestionProjects.Domain.Enums.StatutDemande.CorrectionDemandeeParDirecteurMetier ||
                       Model.StatutDemande == GestionProjects.Domain.Enums.StatutDemande.RetourneeAuDemandeurParDSI;
}

<div class="fade-in">
    <div class="card-modern mb-4">
        <div class="card-header-modern">
            <h2 class="card-title-modern">
                <i class="bi bi-pencil"></i>
                @(isCorrection ? "Corriger la Demande" : "Modifier la Demande")
            </h2>
        </div>
        @if (isCorrection)
        {
            <div class="card-body-modern" style="background: #fef3c7; border-top: 1px solid var(--gray-200);">
                <div style="display: flex; align-items: center; gap: var(--spacing-md);">
                    <i class="bi bi-exclamation-triangle-fill" style="color: var(--warning); font-size: 1.5rem;"></i>
                    <div>
                        <strong style="color: #92400e;">Correction demandée</strong>
                        <p style="color: #92400e; margin: 0; font-size: 0.875rem;">
                            @if (!string.IsNullOrEmpty(Model.CommentaireDirecteurMetier))
                            {
                                @Model.CommentaireDirecteurMetier
                            }
                            else if (!string.IsNullOrEmpty(Model.CommentaireDSI))
                            {
                                @Model.CommentaireDSI
                            }
                        </p>
                    </div>
                </div>
            </div>
        }
    </div>

    <form asp-action="Edit" method="post" enctype="multipart/form-data">
        @Html.AntiForgeryToken()
        <input type="hidden" asp-for="Id" />
        
        @await Html.PartialAsync("_ValidationSummary")

        <div class="row">
            <div class="col-md-8">
                <div class="card-modern mb-4">
                    <div class="card-header-modern">
                        <h3 class="card-title-modern" style="font-size: 1.1rem;">
                            <i class="bi bi-info-circle"></i>
                            Informations générales
                        </h3>
                    </div>
                    <div class="card-body-modern">
                        <div class="form-group-modern">
                            <label asp-for="Titre" class="form-label-modern">Titre du projet *</label>
                            <input asp-for="Titre" class="form-control-modern" required />
                            <span asp-validation-for="Titre" class="text-danger"></span>
                        </div>

                        <div class="form-group-modern">
                            <label asp-for="Description" class="form-label-modern">Description *</label>
                            <textarea asp-for="Description" class="form-control-modern" rows="4" required></textarea>
                            <span asp-validation-for="Description" class="text-danger"></span>
                        </div>

                        <div class="form-group-modern">
                            <label asp-for="Contexte" class="form-label-modern">Contexte *</label>
                            <textarea asp-for="Contexte" class="form-control-modern" rows="4" required></textarea>
                            <span asp-validation-for="Contexte" class="text-danger"></span>
                        </div>

                        <div class="form-group-modern">
                            <label asp-for="Objectifs" class="form-label-modern">Objectifs *</label>
                            <textarea asp-for="Objectifs" class="form-control-modern" rows="4" required></textarea>
                            <span asp-validation-for="Objectifs" class="text-danger"></span>
                        </div>

                        <div class="form-group-modern">
                            <label asp-for="AvantagesAttendus" class="form-label-modern">Avantages attendus</label>
                            <textarea asp-for="AvantagesAttendus" class="form-control-modern" rows="3"></textarea>
                        </div>

                        <div class="form-group-modern">
                            <label asp-for="Perimetre" class="form-label-modern">Périmètre</label>
                            <textarea asp-for="Perimetre" class="form-control-modern" rows="4" placeholder="Processus impactés, population concernée, budget estimé..."></textarea>
                            <small class="text-muted" style="font-size: 0.75rem; color: var(--gray-500);">Décrivez le périmètre du projet (processus impactés, population concernée, budget estimé si disponible)</small>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card-modern mb-4">
                    <div class="card-header-modern">
                        <h3 class="card-title-modern" style="font-size: 1.1rem;">
                            <i class="bi bi-gear"></i>
                            Paramètres
                        </h3>
                    </div>
                    <div class="card-body-modern">
                        <div class="form-group-modern">
                            <label asp-for="DirectionId" class="form-label-modern">Direction *</label>
                            <select asp-for="DirectionId" id="DirectionId" class="form-control-modern" asp-items="ViewBag.Directions" required>
                                <option value="">-- Sélectionner --</option>
                            </select>
                            <span asp-validation-for="DirectionId" class="text-danger"></span>
                        </div>

                        <div class="form-group-modern">
                            <label asp-for="DirecteurMetierId" class="form-label-modern">Directeur Métier *</label>
                            <select asp-for="DirecteurMetierId" id="DirecteurMetierId" class="form-control-modern" required>
                                <option value="">-- Sélectionner d'abord une Direction --</option>
                            </select>
                            <span asp-validation-for="DirecteurMetierId" class="text-danger"></span>
                            <small class="text-muted" id="directeurMetierHelp" style="font-size: 0.75rem; color: var(--gray-500); display: none;">
                                <i class="bi bi-info-circle"></i> Sélectionnez une direction pour voir les directeurs métier disponibles
                            </small>
                        </div>

                        <div class="form-group-modern">
                            <label asp-for="Urgence" class="form-label-modern">Urgence *</label>
                            <select asp-for="Urgence" class="form-control-modern" asp-items="Html.GetEnumSelectList<GestionProjects.Domain.Enums.UrgenceProjet>()" required></select>
                            <span asp-validation-for="Urgence" class="text-danger"></span>
                        </div>

                        <div class="form-group-modern">
                            <label asp-for="Criticite" class="form-label-modern">Criticité *</label>
                            <select asp-for="Criticite" class="form-control-modern" asp-items="Html.GetEnumSelectList<GestionProjects.Domain.Enums.CriticiteProjet>()" required></select>
                            <span asp-validation-for="Criticite" class="text-danger"></span>
                        </div>

                        <div class="form-group-modern">
                            <label asp-for="DateMiseEnOeuvreSouhaitee" class="form-label-modern">Date mise en œuvre souhaitée</label>
                            <input asp-for="DateMiseEnOeuvreSouhaitee" type="date" class="form-control-modern" />
                        </div>
                    </div>
                </div>

                <div class="card-modern">
                    <div class="card-header-modern">
                        <h3 class="card-title-modern" style="font-size: 1.1rem;">
                            <i class="bi bi-file-earmark"></i>
                            Documents
                        </h3>
                    </div>
                    <div class="card-body-modern">
                        @if (!string.IsNullOrEmpty(Model.CahierChargesPath))
                        {
                            <div style="margin-bottom: var(--spacing-md); padding: var(--spacing-md); background: var(--gray-50); border-radius: var(--radius-lg);">
                                <div style="font-size: 0.875rem; color: var(--gray-600); margin-bottom: var(--spacing-xs);">Fichier actuel :</div>
                                <a href="~/@Model.CahierChargesPath" target="_blank" style="color: var(--primary-blue); text-decoration: none;">
                                    <i class="bi bi-file-earmark-pdf"></i> Voir le fichier
                                </a>
                            </div>
                        }
                        <div class="form-group-modern">
                            <label class="form-label-modern">@(string.IsNullOrEmpty(Model.CahierChargesPath) ? "Cahier des charges" : "Nouveau cahier des charges")</label>
                            <input type="file" name="cahierCharges" class="form-control-modern" accept=".pdf,.doc,.docx" />
                        </div>

                        @if (Model.Annexes != null && Model.Annexes.Any())
                        {
                            <div style="margin-bottom: var(--spacing-md); padding: var(--spacing-md); background: var(--gray-50); border-radius: var(--radius-lg);">
                                <div style="font-size: 0.875rem; color: var(--gray-600);">Annexes existantes : @Model.Annexes.Count() fichier(s)</div>
                            </div>
                        }
                        <div class="form-group-modern">
                            <label class="form-label-modern">@(Model.Annexes != null && Model.Annexes.Any() ? "Nouvelles annexes" : "Annexes")</label>
                            <input type="file" name="annexes" class="form-control-modern" multiple accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.png" />
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="d-flex gap-3 mt-4">
            <button type="submit" class="btn-modern btn-modern-primary">
                <i class="bi bi-save"></i>
                @(isCorrection ? "Enregistrer les corrections" : "Enregistrer")
            </button>
            <a asp-action="Details" asp-route-id="@Model.Id" class="btn-modern btn-modern-secondary">
                <i class="bi bi-x-circle"></i>
                Annuler
            </a>
        </div>
    </form>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    
    <script type="text/javascript">
        (function() {
            const directionSelect = document.getElementById('DirectionId');
            const directeurMetierSelect = document.getElementById('DirecteurMetierId');
            const directeurMetierHelp = document.getElementById('directeurMetierHelp');
            
            if (!directionSelect || !directeurMetierSelect) return;
            
            // Sauvegarder la valeur actuelle du directeur métier (si elle existe)
            const currentDirecteurMetierId = directeurMetierSelect.value;
            
            function loadDirecteursMetier(directionId, selectedId) {
                if (!directionId) {
                    directeurMetierSelect.innerHTML = '<option value="">-- Sélectionner d\'abord une Direction --</option>';
                    directeurMetierSelect.disabled = true;
                    directeurMetierHelp.style.display = 'block';
                    return;
                }
                
                directeurMetierHelp.style.display = 'none';
                directeurMetierSelect.innerHTML = '<option value="">-- Chargement... --</option>';
                directeurMetierSelect.disabled = true;
                
                // Appel AJAX pour récupérer les directeurs métier de la direction
                fetch(`/DemandeProjet/GetDirecteursMetierByDirection?directionId=${directionId}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Erreur lors du chargement des directeurs métier');
                        }
                        return response.json();
                    })
                    .then(data => {
                        directeurMetierSelect.innerHTML = '<option value="">-- Sélectionner --</option>';
                        
                        if (data && data.length > 0) {
                            data.forEach(function(dm) {
                                const option = document.createElement('option');
                                option.value = dm.id;
                                option.textContent = dm.text;
                                // Pré-sélectionner si c'est la valeur actuelle
                                if (selectedId && dm.id === selectedId) {
                                    option.selected = true;
                                }
                                directeurMetierSelect.appendChild(option);
                            });
                            directeurMetierSelect.disabled = false;
                        } else {
                            directeurMetierSelect.innerHTML = '<option value="">-- Aucun directeur métier trouvé pour cette direction --</option>';
                            directeurMetierSelect.disabled = true;
                        }
                    })
                    .catch(error => {
                        console.error('Erreur:', error);
                        directeurMetierSelect.innerHTML = '<option value="">-- Erreur lors du chargement --</option>';
                        directeurMetierSelect.disabled = true;
                    });
            }
            
            directionSelect.addEventListener('change', function() {
                loadDirecteursMetier(this.value, null);
            });
            
            // Si une direction est déjà sélectionnée au chargement, charger les directeurs métier
            if (directionSelect.value) {
                loadDirecteursMetier(directionSelect.value, currentDirecteurMetierId);
            }
        })();
    </script>
}
